#!/usr/bin/env bash
set -ue

# Run this as sudo!
if [ $(id -u) != 0 ]; then
    echo "need to switch to root to install necessary packages"
    sudo "$0" "$@"
    exit $?
fi

echo "running first-time setup of klamann's dotfiles for" \
     "{{ .chezmoi.username }}@{{ .chezmoi.hostname }} on {{ .chezmoi.osRelease.name }}"

# define package manager and packages
packages=(
    curl
    git
    nano
    zsh
)
{{ if (eq .chezmoi.osRelease.id "debian" "ubuntu") -}}
update='apt-get update'
install='apt-get install -y'
packages+=(htop passwd tldr)
{{ else if (eq .chezmoi.osRelease.id "alpine") -}}
update='apk update'
install='apk add'
packages+=(htop shadow which)
{{ else if (eq .chezmoi.osRelease.id "arch") -}}
update='pacman -Sy'
install='pacman -S --noconfirm'
packages+=(htop util-linux tldr which)
{{ else if (eq (trimAll "\"" .chezmoi.osRelease.id) "centos") -}}
update='dnf check-update'
install='dnf -y install'
packages+=(util-linux-user which)
{{ else if (eq .chezmoi.osRelease.id "fedora") -}}
update='dnf check-update'
install='dnf -y install'
packages+=(htop util-linux-user tldr which)
{{ else -}}
echo "unexpected distribution {{ .chezmoi.osRelease.id }}, cannot install packages"
exit 1
{{ end }}

# install packages
echo "updating package index and installing packages ${packages[@]}"
{{ if (eq (trimAll "\"" .chezmoi.osRelease.id) "centos") -}}
$install glibc-langpack-en || true
{{ end }}
$update || true
$install "${packages[@]}"

# switch to zsh
echo "setting zsh as login shell for {{ .chezmoi.username }}"
chsh {{ .chezmoi.username }} -s $(which zsh)
